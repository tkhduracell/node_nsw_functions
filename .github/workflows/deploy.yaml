name: Deploy

on:
  push:
    branches:
      - main

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x]

    permissions:
      contents: 'read'
      id-token: 'write'

    env:
      GCLOUD_REGION: europe-north1
      GCLOUD_SCHEDULER_REGION: europe-west6
      GCLOUD_BUCKET: nackswinget-af7ef.appspot.com

    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build source
        run: npm run build --if-present

      - id: 'auth'
        name: Setup  gcloud Cloud SDK auth
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: 'projects/560237127162/locations/global/workloadIdentityPools/github-deployer-auth-pool/providers/github-deployer-auth-provider'
          service_account: 'github-deployer-account@nackswinget-af7ef.iam.gserviceaccount.com'

      - name: Set up gcloud Cloud SDK environment
        uses: google-github-actions/setup-gcloud@v1.1.0

      - name: Deploy function competitions
        run: |
          gcloud --project "${GCLOUD_PROJECT}" functions deploy competitions-get \
            --gen2 \
            --runtime=nodejs16 \
            --region="${GCLOUD_REGION}" \
            --source=. \
            --entry-point=competitions \
            --trigger-http \
            --max-instances=5 \
            --allow-unauthenticated

      - name: Deploy function calendar-subscribe
        run: |
          gcloud --project "${GCLOUD_PROJECT}" functions deploy calendar-subscribe \
            --gen2 \
            --runtime=nodejs16 \
            --region="${GCLOUD_REGION}" \
            --source=. \
            --entry-point=subscribe \
            --trigger-http \
            --max-instances=5 \
            --allow-unauthenticated \
            --update-secrets=ACTIVITY_ORG_ID=ACTIVITY_ORG_ID:latest,ACTIVITY_BASE_URL=ACTIVITY_BASE_URL:latest,ACTIVITY_USERNAME=ACTIVITY_USERNAME:latest,ACTIVITY_PASSWORD=ACTIVITY_PASSWORD:latest \
            --update-env-vars=GCLOUD_PROJECT=${GCLOUD_PROJECT},GCLOUD_BUCKET=${GCLOUD_BUCKET},GCLOUD_REGION=${GCLOUD_REGION}

      - name: Deploy function calendar-unsubscribe
        run: |
          gcloud --project "${GCLOUD_PROJECT}" functions deploy calendar-unsubscribe \
            --gen2 \
            --runtime=nodejs16 \
            --region="${GCLOUD_REGION}" \
            --source=. \
            --entry-point=unsubscribe \
            --trigger-http \
            --max-instances=5 \
            --allow-unauthenticated \
            --update-secrets=ACTIVITY_ORG_ID=ACTIVITY_ORG_ID:latest,ACTIVITY_BASE_URL=ACTIVITY_BASE_URL:latest,ACTIVITY_USERNAME=ACTIVITY_USERNAME:latest,ACTIVITY_PASSWORD=ACTIVITY_PASSWORD:latest \
            --update-env-vars=GCLOUD_PROJECT=${GCLOUD_PROJECT},GCLOUD_BUCKET=${GCLOUD_BUCKET},GCLOUD_REGION=${GCLOUD_REGION}

      - name: Deploy function calendar-export-get
        run: |
          gcloud --project "${GCLOUD_PROJECT}" functions deploy calendar-export-get \
            --gen2 \
            --runtime=nodejs16 \
            --region="${GCLOUD_REGION}" \
            --source=. \
            --entry-point=get \
            --trigger-http \
            --max-instances=5 \
            --allow-unauthenticated \
            --update-secrets=ACTIVITY_ORG_ID=ACTIVITY_ORG_ID:latest,ACTIVITY_BASE_URL=ACTIVITY_BASE_URL:latest,ACTIVITY_USERNAME=ACTIVITY_USERNAME:latest,ACTIVITY_PASSWORD=ACTIVITY_PASSWORD:latest \
            --update-env-vars=GCLOUD_PROJECT=${GCLOUD_PROJECT},GCLOUD_BUCKET=${GCLOUD_BUCKET},GCLOUD_REGION=${GCLOUD_REGION}

      - name: Deploy function calendar-export-update
        run: |
          export GCLOUD_FUNCITON_GET_URL=$(gcloud functions --project ${GCLOUD_PROJECT} --region=${GCLOUD_REGION} describe calendar-export-get --gen2 --format='value(serviceConfig.uri)')
          gcloud --project "${GCLOUD_PROJECT}" functions deploy calendar-export-update \
            --gen2 \
            --runtime=nodejs16 \
            --region="${GCLOUD_REGION}" \
            --source=. \
            --entry-point=update \
            --trigger-http \
            --memory=1024MB \
            --max-instances=1 \
            --allow-unauthenticated \
            --update-secrets=ACTIVITY_ORG_ID=ACTIVITY_ORG_ID:latest,ACTIVITY_BASE_URL=ACTIVITY_BASE_URL:latest,ACTIVITY_USERNAME=ACTIVITY_USERNAME:latest,ACTIVITY_PASSWORD=ACTIVITY_PASSWORD:latest \
            --update-env-vars=GCLOUD_PROJECT=${GCLOUD_PROJECT},GCLOUD_BUCKET=${GCLOUD_BUCKET},GCLOUD_REGION=${GCLOUD_REGION},GCLOUD_FUNCITON_GET_URL=${GCLOUD_FUNCITON_GET_URL}

      - name: Update function scheduler
        run: |
          export CLOUD_FUNCTION_UPDATE_URL=$(gcloud functions --project ${GCLOUD_PROJECT} --region=${GCLOUD_REGION} describe calendar-export-update --gen2 --format='value(serviceConfig.uri)')
          echo "CLOUD_FUNCTION_UPDATE_URL: ${CLOUD_FUNCTION_UPDATE_URL}"
          gcloud scheduler jobs update http calendar-update-half-hourly --project "${GCLOUD_PROJECT}" \
            --schedule "*/30 * * * *" \
            --time-zone "Europe/Stockholm" \
            --http-method GET \
            --uri "${CLOUD_FUNCTION_UPDATE_URL}" \
            --location ${GCLOUD_SCHEDULER_REGION} \
            --description="calendar-export-update: Update NSW GCS ics files (half-hourly)"
