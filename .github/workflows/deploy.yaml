name: Deploy

on:
  push:
    branches:
      - main

env:
  GCLOUD_REGION: europe-north1
  GCLOUD_SCHEDULER_REGION: europe-west6
  GCLOUD_BUCKET: nackswinget-af7ef.appspot.com

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build source
        run: npm run build --if-present

  deploy-notifications-api:
    runs-on: ubuntu-latest
    needs: 'build'
    concurrency: 'notifications-api'
    strategy:
      matrix:
        node-version: [16.x]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build source
        run: npm run build --if-present

      - id: 'auth'
        name: Setup  gcloud Cloud SDK auth
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: 'projects/560237127162/locations/global/workloadIdentityPools/github-deployer-auth-pool/providers/github-deployer-auth-provider'
          service_account: 'github-deployer-account@nackswinget-af7ef.iam.gserviceaccount.com'

      - name: Set up gcloud Cloud SDK environment
        uses: google-github-actions/setup-gcloud@v1

      - name: Setup default project
        run: gcloud config set project "${GCLOUD_PROJECT}"

      - name: Deploy function notifications-api
        run: |
          gcloud functions deploy notifications-api \
            --gen2 \
            --runtime=nodejs16 \
            --region="${GCLOUD_REGION}" \
            --source=. \
            --entry-point=notifications-api \
            --trigger-http \
            --max-instances=5 \
            --allow-unauthenticated \
            --update-secrets=ACTIVITY_ORG_ID=ACTIVITY_ORG_ID:latest,ACTIVITY_BASE_URL=ACTIVITY_BASE_URL:latest,ACTIVITY_USERNAME=ACTIVITY_USERNAME:latest,ACTIVITY_PASSWORD=ACTIVITY_PASSWORD:latest \
            --update-env-vars=GCLOUD_PROJECT=${GCLOUD_PROJECT},GCLOUD_BUCKET=${GCLOUD_BUCKET},GCLOUD_REGION=${GCLOUD_REGION}

  deploy-competitions-api:
    runs-on: ubuntu-latest
    needs: 'build'
    concurrency: 'competitions-api'
    strategy:
      matrix:
        node-version: [16.x]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build source
        run: npm run build --if-present

      - id: 'auth'
        name: Setup  gcloud Cloud SDK auth
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: 'projects/560237127162/locations/global/workloadIdentityPools/github-deployer-auth-pool/providers/github-deployer-auth-provider'
          service_account: 'github-deployer-account@nackswinget-af7ef.iam.gserviceaccount.com'

      - name: Set up gcloud Cloud SDK environment
        uses: google-github-actions/setup-gcloud@v1

      - name: Setup default project
        run: gcloud config set project "${GCLOUD_PROJECT}"

      - name: Deploy function competitions
        run: |
          gcloud functions deploy competitions-get \
            --gen2 \
            --runtime=nodejs16 \
            --region="${GCLOUD_REGION}" \
            --source=. \
            --entry-point=competitions \
            --trigger-http \
            --max-instances=5 \
            --allow-unauthenticated

  deploy-calendar-api:
    runs-on: ubuntu-latest
    needs: 'build'
    concurrency: 'calendar-api'
    strategy:
      matrix:
        node-version: [16.x]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build source
        run: npm run build --if-present

      - id: 'auth'
        name: Setup  gcloud Cloud SDK auth
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: 'projects/560237127162/locations/global/workloadIdentityPools/github-deployer-auth-pool/providers/github-deployer-auth-provider'
          service_account: 'github-deployer-account@nackswinget-af7ef.iam.gserviceaccount.com'

      - name: Set up gcloud Cloud SDK environment
        uses: google-github-actions/setup-gcloud@v1

      - name: Setup default project
        run: gcloud config set project "${GCLOUD_PROJECT}"

      - name: Deploy function calendars-api
        run: |
          gcloud functions deploy calendars-api \
            --gen2 \
            --runtime=nodejs16 \
            --region="${GCLOUD_REGION}" \
            --source=. \
            --entry-point=calendars-api \
            --trigger-http \
            --max-instances=5 \
            --allow-unauthenticated \
            --update-secrets=ACTIVITY_ORG_ID=ACTIVITY_ORG_ID:latest,ACTIVITY_BASE_URL=ACTIVITY_BASE_URL:latest,ACTIVITY_USERNAME=ACTIVITY_USERNAME:latest,ACTIVITY_PASSWORD=ACTIVITY_PASSWORD:latest \
            --update-env-vars=GCLOUD_PROJECT=${GCLOUD_PROJECT},GCLOUD_BUCKET=${GCLOUD_BUCKET},GCLOUD_REGION=${GCLOUD_REGION}

      - name: Deploy function calendars-update-api
        run: |
          gcloud functions deploy calendars-update-api \
            --gen2 \
            --runtime=nodejs16 \
            --region="${GCLOUD_REGION}" \
            --source=. \
            --entry-point=calendars-update-api \
            --trigger-http \
            --memory=1024MB \
            --max-instances=1 \
            --allow-unauthenticated \
            --update-secrets=ACTIVITY_ORG_ID=ACTIVITY_ORG_ID:latest,ACTIVITY_BASE_URL=ACTIVITY_BASE_URL:latest,ACTIVITY_USERNAME=ACTIVITY_USERNAME:latest,ACTIVITY_PASSWORD=ACTIVITY_PASSWORD:latest \
            --update-env-vars=GCLOUD_PROJECT=${GCLOUD_PROJECT},GCLOUD_BUCKET=${GCLOUD_BUCKET},GCLOUD_REGION=${GCLOUD_REGION},GCLOUD_FUNCITON_GET_URL=$(gcloud functions describe calendars-api --gen2 --format='value(serviceConfig.uri)' --region="${GCLOUD_REGION}")

      - name: Update function scheduler calendar-update-30m
        run: |
          gcloud scheduler jobs update http calendar-update-30m \
            --schedule "*/30 0-1,6-23 * * *" \
            --time-zone "Europe/Stockholm" \
            --http-method POST \
            --uri $(gcloud functions describe calendars-update-api --gen2 --format='value(serviceConfig.uri)' --region="${GCLOUD_REGION}")/update \
            --location ${GCLOUD_SCHEDULER_REGION} \
            --description "calendars-update-api: Update NSW GCS .ics files (30m)"

      - name: Update function scheduler calendar-update-lean-5m
        run: |
          gcloud scheduler jobs update http calendar-update-lean-5m \
            --schedule "*/5 0-1,7-23 * * *" \
            --time-zone "Europe/Stockholm" \
            --http-method POST \
            --uri $(gcloud functions describe calendars-update-api --gen2 --format='value(serviceConfig.uri)' --region=${GCLOUD_REGION})/update-lean \
            --location ${GCLOUD_SCHEDULER_REGION} \
            --description "calendars-update-api: Lean update NSW GCS .ics files (5m)"
